import{c as ce,i as de}from"./lucide-CsvaVU3k.js";import"./mobileMenu-BgUUa2aN.js";import"./version-C9vromJL.js";import{G as _e,P as Ve,g as Qe,e as y,i as et,j as tt,k as le}from"./shortcuts-C-IEUyZ3.js";import{i as nt}from"./shortcuts-init-5EjMyyzi.js";_e.workerSrc=new URL("/assets/pdf.worker.min-qwK7q_zL.mjs",import.meta.url).toString();const j=document.getElementById("modal-container");let ie=!1,re=null,q=null,ae=null,Se=null,J=1;function Ee(e,t=[],n={}){return new Promise(o=>{const i=document.createElement("div");i.className="modal-overlay",i.id="active-modal-overlay";const l=document.createElement("div");l.className="modal-content",l.id="active-modal";const E=t.map(s=>{if(s.type==="text")return`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
                                <input type="text" id="modal-${s.name}" value="${We(n[s.name]||"")}" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-lg" 
                                    placeholder="${s.placeholder||""}" />
                            </div>
                        `;if(s.type==="select")return`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
                                <select id="modal-${s.name}" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    ${s.options.map(a=>`
                                        <option value="${a.value}" ${n[s.name]===a.value?"selected":""}>
                                            ${a.label}
                                        </option>
                                    `).join("")}
                                </select>
                                ${s.name==="color"?'<input type="color" id="modal-color-picker" class="hidden w-full h-10 mt-2 rounded cursor-pointer border border-gray-300" value="#000000" />':""}
                            </div>
                        `;if(s.type==="destination"){const a=n.destX!==null&&n.destX!==void 0;return`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
                                <div class="p-3 bg-gray-50 rounded-lg border border-gray-200 space-y-2">
                                    <div class="flex items-center gap-2">
                                        <label class="flex items-center gap-1 text-xs">
                                            <input type="checkbox" id="modal-use-destination" class="w-4 h-4" ${a?"checked":""}>
                                            <span>Set custom destination</span>
                                        </label>
                                    </div>
                                    <div id="destination-controls" class="${a?"":"hidden"} space-y-2">
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-600">Page</label>
                                                <input type="number" id="modal-dest-page" min="1" max="${s.maxPages||1}" value="${n.destPage||s.page||1}" 
                                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm" step="1" />
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-600">Zoom (%)</label>
                                                <select id="modal-dest-zoom" class="w-full px-2 py-1 border border-gray-300 rounded text-sm">
                                                    <option value="">Inherit</option>
                                                    <option value="0">Fit Page</option>
                                                    <option value="50">50%</option>
                                                    <option value="75">75%</option>
                                                    <option value="100">100%</option>
                                                    <option value="125">125%</option>
                                                    <option value="150">150%</option>
                                                    <option value="200">200%</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-2">
                                            <div>
                                                <label class="text-xs text-gray-600">X Position</label>
                                                <input type="number" id="modal-dest-x" value="0" step="10"
                                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm" />
                                            </div>
                                            <div>
                                                <label class="text-xs text-gray-600">Y Position</label>
                                                <input type="number" id="modal-dest-y" value="0" step="10"
                                                    class="w-full px-2 py-1 border border-gray-300 rounded text-sm" />
                                            </div>
                                        </div>
                                        <button id="modal-pick-destination" class="w-full px-3 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs flex items-center justify-center gap-1">
                                            <i data-lucide="crosshair" class="w-3 h-3"></i> Click on PDF to Pick Location
                                        </button>
                                        <p class="text-xs text-gray-500 italic">Click the button above, then click on the PDF where you want the bookmark to jump to</p>
                                    </div>
                                </div>
                            </div>
                        `}else if(s.type==="preview")return`
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 mb-2">${s.label}</label>
                                <div id="modal-preview" class="style-preview bg-gray-50">
                                    <span id="preview-text" style="font-size: 16px;">Preview Text</span>
                                </div>
                            </div>
                        `;return""}).join("");l.innerHTML=`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">${e}</h3>
                        <div class="mb-6">
                            ${E}
                        </div>
                        <div class="flex gap-2 justify-end">
                            <button id="modal-cancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
                            <button id="modal-confirm" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">Confirm</button>
                        </div>
                    </div>
                `,i.appendChild(l),j.appendChild(i);function g(){const s=l.querySelector("#preview-text");if(s){const a=l.querySelector("#modal-title"),m=l.querySelector("#modal-color"),f=l.querySelector("#modal-style"),w=l.querySelector("#modal-color-picker"),I=a?a.value:"Preview Text",X=m?m.value:"",F=f?f.value:"";s.textContent=I||"Preview Text";const Ge={red:"#dc2626",blue:"#2563eb",green:"#16a34a",yellow:"#ca8a04",purple:"#9333ea"};X==="custom"&&w?s.style.color=w.value:s.style.color=Ge[X]||"#000",s.style.fontWeight=F==="bold"||F==="bold-italic"?"bold":"normal",s.style.fontStyle=F==="italic"||F==="bold-italic"?"italic":"normal"}}const d=l.querySelector("#modal-title"),h=l.querySelector("#modal-color"),c=l.querySelector("#modal-style");d&&d.addEventListener("input",g),h&&h.addEventListener("change",s=>{const a=l.querySelector("#modal-color-picker");s.target.value==="custom"&&a?(a.classList.remove("hidden"),setTimeout(()=>a.click(),100)):a&&a.classList.add("hidden"),g()});const p=l.querySelector("#modal-color-picker");p&&p.addEventListener("input",g),c&&c.addEventListener("change",g);const u=l.querySelector("#modal-use-destination"),v=l.querySelector("#destination-controls"),r=l.querySelector("#modal-pick-destination");if(u&&v&&(u.addEventListener("change",s=>{v.classList.toggle("hidden",!s.target.checked)}),n.destX!==null&&n.destX!==void 0)){const s=l.querySelector("#modal-dest-page"),a=l.querySelector("#modal-dest-x"),m=l.querySelector("#modal-dest-y"),f=l.querySelector("#modal-dest-zoom");s&&n.destPage!==void 0&&(s.value=n.destPage),a&&n.destX!==null&&(a.value=Math.round(n.destX)),m&&n.destY!==null&&(m.value=Math.round(n.destY)),f&&n.zoom!==null&&(f.value=n.zoom||"")}r&&r.addEventListener("click",()=>{ae=i,i.style.display="none",ot((s,a,m)=>{const f=l.querySelector("#modal-dest-page"),w=l.querySelector("#modal-dest-x"),I=l.querySelector("#modal-dest-y");f&&(f.value=s),w&&(w.value=Math.round(a)),I&&(I.value=Math.round(m)),i.style.display="",setTimeout(()=>{x()},100)})});const b=l.querySelector("#modal-dest-page");b&&(b.addEventListener("input",s=>{const a=parseInt(s.target.value),m=parseInt(s.target.max)||1;isNaN(a)||a<1?s.target.value=1:a>m?s.target.value=m:s.target.value=Math.floor(a),x()}),b.addEventListener("blur",s=>{const a=parseInt(s.target.value),m=parseInt(s.target.max)||1;isNaN(a)||a<1?s.target.value=1:a>m?s.target.value=m:s.target.value=Math.floor(a),x()}));function x(){if(!z)return;const s=l.querySelector("#modal-dest-page"),a=l.querySelector("#modal-dest-x"),m=l.querySelector("#modal-dest-y"),f=l.querySelector("#modal-dest-zoom"),w=s?parseInt(s.value):D,I=a?parseFloat(a.value):null,X=m?parseFloat(m.value):null,F=f?f.value:null;w>=1&&w<=z.numPages&&Ye(w,I,X,F)}const S=l.querySelector("#modal-dest-x"),M=l.querySelector("#modal-dest-y"),P=l.querySelector("#modal-dest-zoom");S&&S.addEventListener("input",x),M&&M.addEventListener("input",x),P&&P.addEventListener("change",x),g(),l.querySelector("#modal-cancel").addEventListener("click",()=>{V(),j.removeChild(i),o(null)}),l.querySelector("#modal-confirm").addEventListener("click",()=>{const s={};t.forEach(w=>{if(w.type!=="preview"&&w.type!=="destination"){const I=l.querySelector(`#modal-${w.name}`);s[w.name]=I.value}});const a=l.querySelector("#modal-color"),m=l.querySelector("#modal-color-picker");a&&a.value==="custom"&&m&&(s.color=m.value);const f=l.querySelector("#modal-use-destination");if(f&&f.checked){const w=l.querySelector("#modal-dest-page"),I=l.querySelector("#modal-dest-x"),X=l.querySelector("#modal-dest-y"),F=l.querySelector("#modal-dest-zoom");s.destPage=w?parseInt(w.value):null,s.destX=I?parseFloat(I.value):null,s.destY=X?parseFloat(X.value):null,s.zoom=F&&F.value?F.value:null}else s.destPage=null,s.destX=null,s.destY=null,s.zoom=null;V(),j.removeChild(i),o(s)}),i.addEventListener("click",s=>{s.target===i&&(V(),j.removeChild(i),o(null))}),setTimeout(()=>{const s=l.querySelector("input, select");s&&s.focus()},0),ce({icons:de})})}function ot(e){ie=!0,re=e;const t=document.getElementById("pdf-canvas-wrapper"),n=document.getElementById("picking-mode-banner");t.classList.add("picking-mode"),n.classList.remove("hidden"),window.innerWidth<1024&&document.getElementById("show-viewer-btn").click(),ce({icons:de})}function V(){ie=!1,re=null;const e=document.getElementById("pdf-canvas-wrapper"),t=document.getElementById("picking-mode-banner");e.classList.remove("picking-mode"),t.classList.add("hidden"),q&&(q.remove(),q=null);const n=document.getElementById("destination-coord-display");n&&n.remove(),ae&&(ae.style.display="",ae=null)}document.addEventListener("DOMContentLoaded",()=>{nt();const e=document.getElementById("pdf-canvas"),t=document.getElementById("pdf-canvas-wrapper"),n=document.getElementById("cancel-picking-btn");let o=null;t.addEventListener("mousemove",i=>{if(!ie)return;const l=e.getBoundingClientRect(),E=i.clientX-l.left,g=i.clientY-l.top;o||(o=document.createElement("div"),o.className="coordinate-tooltip",t.appendChild(o)),o.textContent=`X: ${Math.round(E)}, Y: ${Math.round(g)}`,o.style.left=i.clientX-l.left+15+"px",o.style.top=i.clientY-l.top+15+"px"}),t.addEventListener("mouseleave",()=>{o&&(o.remove(),o=null)}),e.addEventListener("click",async i=>{if(!ie||!re)return;const l=e.getBoundingClientRect(),E=i.clientX-l.left,g=i.clientY-l.top;let d=Se;d||(d=(await z.getPage(D)).getViewport({scale:J}));const h=d.width/l.width,c=d.height/l.height,p=E*h,u=d.height-g*c;q&&q.remove();const v=document.getElementById("destination-coord-display");v&&v.remove(),q=document.createElement("div"),q.className="destination-marker",q.innerHTML=`
                    <svg viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                        <circle cx="12" cy="12" r="10" fill="#3b82f6" fill-opacity="0.2"/>
                        <path d="M12 2 L12 22 M2 12 L22 12"/>
                        <circle cx="12" cy="12" r="2" fill="#3b82f6"/>
                    </svg>
                `;const r=e.getBoundingClientRect(),b=t.getBoundingClientRect();q.style.position="absolute",q.style.left=E+r.left-b.left+"px",q.style.top=g+r.top-b.top+"px",t.appendChild(q);const x=document.createElement("div");x.id="destination-coord-display",x.className="absolute bg-blue-500 text-white px-2 py-1 rounded text-xs font-mono z-50 pointer-events-none",x.style.left=E+r.left-b.left+20+"px",x.style.top=g+r.top-b.top-30+"px",x.textContent=`X: ${Math.round(p)}, Y: ${Math.round(u)}`,t.appendChild(x),re(D,p,u),setTimeout(()=>{V()},500)}),n&&n.addEventListener("click",()=>{V()})});function te(e){return new Promise(t=>{const n=document.createElement("div");n.className="modal-overlay";const o=document.createElement("div");o.className="modal-content",o.innerHTML=`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Confirm Action</h3>
                        <p class="text-gray-600 mb-6">${e}</p>
                        <div class="flex gap-2 justify-end">
                            <button id="modal-cancel" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300">Cancel</button>
                            <button id="modal-confirm" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">Confirm</button>
                        </div>
                    </div>
                `,n.appendChild(o),j.appendChild(n),o.querySelector("#modal-cancel").addEventListener("click",()=>{j.removeChild(n),t(!1)}),o.querySelector("#modal-confirm").addEventListener("click",()=>{j.removeChild(n),t(!0)}),n.addEventListener("click",i=>{i.target===n&&(j.removeChild(n),t(!1))})})}function $(e,t){return new Promise(n=>{const o=document.createElement("div");o.className="modal-overlay";const i=document.createElement("div");i.className="modal-content",i.innerHTML=`
                    <div class="p-6">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">${e}</h3>
                        <p class="text-gray-600 mb-6">${t}</p>
                        <div class="flex justify-end">
                            <button id="modal-ok" class="px-4 py-2 rounded bg-blue-500 hover:bg-blue-600 text-white">OK</button>
                        </div>
                    </div>
                `,o.appendChild(i),j.appendChild(o),i.querySelector("#modal-ok").addEventListener("click",()=>{j.removeChild(o),n(!0)}),o.addEventListener("click",l=>{l.target===o&&(j.removeChild(o),n(!0))})})}const be=document.getElementById("file-input"),Ce=document.getElementById("csv-input"),Pe=document.getElementById("json-input"),lt=document.getElementById("auto-extract-checkbox"),Ne=document.getElementById("app"),De=document.getElementById("uploader"),se=document.getElementById("file-display-area"),we=document.getElementById("back-to-tools"),Le=document.getElementById("back-btn"),_=document.getElementById("pdf-canvas"),L=_.getContext("2d"),st=document.getElementById("page-indicator"),at=document.getElementById("prev-page"),it=document.getElementById("next-page"),ue=document.getElementById("goto-page"),Me=document.getElementById("goto-btn"),rt=document.getElementById("zoom-in-btn"),ct=document.getElementById("zoom-out-btn"),dt=document.getElementById("zoom-fit-btn"),Ie=document.getElementById("zoom-indicator"),ze=document.getElementById("add-top-level-btn"),he=document.getElementById("bookmark-title"),fe=document.getElementById("bookmark-tree-list"),Be=document.getElementById("no-bookmarks"),ut=document.getElementById("download-btn"),Te=document.getElementById("undo-btn"),$e=document.getElementById("redo-btn"),mt=document.getElementById("reset-btn"),pt=document.getElementById("delete-all-btn"),gt=document.getElementById("search-bookmarks"),ft=document.getElementById("import-dropdown-btn"),ht=document.getElementById("export-dropdown-btn"),ne=document.getElementById("import-dropdown"),oe=document.getElementById("export-dropdown"),yt=document.getElementById("import-csv-btn"),vt=document.getElementById("export-csv-btn"),bt=document.getElementById("import-json-btn"),kt=document.getElementById("export-json-btn"),ye=document.getElementById("csv-import-hidden"),ve=document.getElementById("json-import-hidden"),xt=document.getElementById("extract-existing-btn"),Et=document.getElementById("current-page-display"),wt=document.getElementById("filename-display"),Lt=document.getElementById("batch-mode-checkbox"),ke=document.getElementById("batch-operations"),It=document.getElementById("selected-count"),Bt=document.getElementById("batch-color-select"),St=document.getElementById("batch-style-select"),Ct=document.getElementById("batch-delete-btn"),Pt=document.getElementById("select-all-btn"),Nt=document.getElementById("deselect-all-btn"),Dt=document.getElementById("expand-all-btn"),Mt=document.getElementById("collapse-all-btn"),K=document.getElementById("show-viewer-btn"),ee=document.getElementById("show-bookmarks-btn"),me=document.getElementById("viewer-section"),pe=document.getElementById("bookmarks-section");function zt(){window.innerWidth>=1024&&(me.classList.remove("hidden"),pe.classList.remove("hidden"),K.classList.remove("bg-blue-50","text-blue-600"),ee.classList.remove("bg-blue-50","text-blue-600"))}window.addEventListener("resize",zt);K.addEventListener("click",()=>{me.classList.remove("hidden"),pe.classList.add("hidden"),K.classList.add("bg-blue-50","text-blue-600"),ee.classList.remove("bg-blue-50","text-blue-600")});ee.addEventListener("click",()=>{me.classList.add("hidden"),pe.classList.remove("hidden"),ee.classList.add("bg-blue-50","text-blue-600"),K.classList.remove("bg-blue-50","text-blue-600")});ft.addEventListener("click",e=>{e.stopPropagation(),ne.classList.toggle("hidden"),oe.classList.add("hidden")});ht.addEventListener("click",e=>{e.stopPropagation(),oe.classList.toggle("hidden"),ne.classList.add("hidden")});document.addEventListener("click",()=>{ne.classList.add("hidden"),oe.classList.add("hidden")});let N=null,z=null,D=1,G="",k=[],R=[],T=-1,H="",Z=null,Q=null,U=!1,C=new Set,A=new Set;const Tt={red:"bg-red-100 border-red-300",blue:"bg-blue-100 border-blue-300",green:"bg-green-100 border-green-300",yellow:"bg-yellow-100 border-yellow-300",purple:"bg-purple-100 border-purple-300"};function O(){R=R.slice(0,T+1),R.push(JSON.parse(JSON.stringify(k))),T++,xe()}function qe(){T>0&&(T--,k=JSON.parse(JSON.stringify(R[T])),B(),xe())}function Oe(){T<R.length-1&&(T++,k=JSON.parse(JSON.stringify(R[T])),B(),xe())}function xe(){Te.disabled=T<=0,$e.disabled=T>=R.length-1}Te.addEventListener("click",qe);$e.addEventListener("click",Oe);mt.addEventListener("click",async()=>{await te("Reset and go back to file uploader? All unsaved changes will be lost.")&&Xe()});pt.addEventListener("click",async()=>{if(k.length===0){await $("Info","No bookmarks to delete.");return}await te(`Delete all ${k.length} bookmark(s)?`)&&(k=[],C.clear(),W(),O(),B())});function Xe(){N=null,z=null,D=1,G="",k=[],R=[],T=-1,H="",Z=null,Q=null,U=!1,C.clear(),A.clear(),be.value="",Ce.value="",Pe.value="",Ne.classList.add("hidden"),De.classList.remove("hidden"),me.classList.remove("hidden"),pe.classList.add("hidden"),K.classList.add("bg-blue-50","text-blue-600"),ee.classList.remove("bg-blue-50","text-blue-600")}document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&(e.key==="z"&&!e.shiftKey?(e.preventDefault(),qe()):(e.key==="z"&&e.shiftKey||e.key==="y")&&(e.preventDefault(),Oe()))});Lt.addEventListener("change",e=>{U=e.target.checked,U||(C.clear(),W()),ke.classList.toggle("hidden",!U||C.size===0),B()});function W(){It.textContent=C.size,U&&ke.classList.toggle("hidden",C.size===0)}Pt.addEventListener("click",()=>{const e=t=>{let n=[];return t.forEach(o=>{n.push(o.id),o.children.length>0&&(n=n.concat(e(o.children)))}),n};e(k).forEach(t=>C.add(t)),W(),B()});Nt.addEventListener("click",()=>{C.clear(),W(),B()});Bt.addEventListener("change",e=>{if(e.target.value&&C.size>0){const t=e.target.value==="null"?null:e.target.value;je(n=>n.color=t),e.target.value=""}});St.addEventListener("change",e=>{if(e.target.value&&C.size>0){const t=e.target.value==="null"?null:e.target.value;je(n=>n.style=t),e.target.value=""}});Ct.addEventListener("click",async()=>{if(C.size===0||!await te(`Delete ${C.size} bookmark(s)?`))return;const t=n=>n.filter(o=>C.has(o.id)?!1:(o.children=t(o.children),!0));k=t(k),C.clear(),W(),O(),B()});function je(e){const t=n=>n.map(o=>(C.has(o.id)&&e(o),o.children=t(o.children),o));k=t(k),O(),B()}Dt.addEventListener("click",()=>{A.clear(),B()});Mt.addEventListener("click",()=>{const e=t=>{t.forEach(n=>{n.children.length>0&&(A.add(n.id),e(n.children))})};e(k),B()});function $t(e){if(e===0)return"0 Bytes";const t=1024,n=["Bytes","KB","MB","GB"],o=Math.floor(Math.log(e)/Math.log(t));return Math.round(e/Math.pow(t,o)*100)/100+" "+n[o]}function qt(e){if(!se)return;se.innerHTML="",se.classList.remove("hidden");const t=document.createElement("div");t.className="flex items-center justify-between bg-gray-700 p-3 rounded-lg text-sm";const n=document.createElement("span");n.className="truncate font-medium text-gray-200",n.textContent=e.name;const o=document.createElement("span");o.className="flex-shrink-0 ml-4 text-gray-400",o.textContent=$t(e.size),t.append(n,o),se.appendChild(t)}be.addEventListener("change",Ot);async function Ot(e){const t=e?e.target.files[0]:be.files[0];if(!t)return;G=t.name.replace(".pdf",""),wt.textContent=G,qt(t);const n=await t.arrayBuffer();if(D=1,k=[],R=[],T=-1,C.clear(),A.clear(),N=await Ve.load(n,{ignoreEncryption:!0}),z=await Qe({data:new Uint8Array(n)}).promise,ue.max=z.numPages,Ne.classList.remove("hidden"),De.classList.add("hidden"),lt.checked){const i=await Ke(N);i.length>0&&(k=i)}Z?(k=Z,Z=null):Q&&(k=Q,Q=null),O(),B(),Y(D),ce({icons:de})}Ce.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text();Z=Ze(n),await $("CSV Loaded",`Loaded ${Z.length} bookmarks from CSV. Now upload your PDF.`)});Pe.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text();try{Q=JSON.parse(n),await $("JSON Loaded","Loaded bookmarks from JSON. Now upload your PDF.")}catch{await $("Error","Invalid JSON format")}});async function Y(e,t=null,n=null,o=null){if(!z)return;const i=await z.getPage(e);let l=J;t!==null&&t!==""&&t!=="0"&&(l=parseFloat(t)/100);const E=window.devicePixelRatio||1;let g=i.getViewport({scale:l});if(Se=g,_.height=g.height*E,_.width=g.width*E,_.style.width=g.width+"px",_.style.height=g.height+"px",L.scale(E,E),await i.render({canvasContext:L,viewport:g}).promise,n!==null&&o!==null){const d=n,h=g.height-o;L.save(),L.strokeStyle="#3b82f6",L.fillStyle="#3b82f6",L.lineWidth=3,L.shadowBlur=10,L.shadowColor="rgba(59, 130, 246, 0.5)",L.beginPath(),L.arc(d,h,12,0,2*Math.PI),L.fill(),L.shadowBlur=0,L.beginPath(),L.moveTo(d-15,h),L.lineTo(d+15,h),L.moveTo(d,h-15),L.lineTo(d,h+15),L.stroke(),L.beginPath(),L.arc(d,h,6,0,2*Math.PI),L.fill(),L.stroke();const c=`X: ${Math.round(n)}, Y: ${Math.round(o)}`;L.font="bold 12px monospace";const u=L.measureText(c).width,v=18;L.fillStyle="rgba(59, 130, 246, 0.95)",L.fillRect(d+18,h-25,u+10,v),L.fillStyle="white",L.fillText(c,d+23,h-10),L.restore()}st.textContent=`Page ${e} / ${z.numPages}`,ue.value=e,D=e,Et.textContent=e}async function Ye(e,t,n,o){await Y(e,o,t,n)}at.addEventListener("click",()=>{D>1&&Y(D-1)});it.addEventListener("click",()=>{D<z.numPages&&Y(D+1)});Me.addEventListener("click",()=>{const e=parseInt(ue.value);e>=1&&e<=z.numPages&&Y(e)});ue.addEventListener("keypress",e=>{e.key==="Enter"&&Me.click()});function ge(){Ie&&(Ie.textContent=`${Math.round(J*100)}%`)}rt.addEventListener("click",()=>{J=Math.min(J+.05,2),ge(),Y(D)});ct.addEventListener("click",()=>{J=Math.max(J-.05,.25),ge(),Y(D)});dt.addEventListener("click",async()=>{z&&(J=1,ge(),Y(D))});ge();gt.addEventListener("input",e=>{H=e.target.value.toLowerCase(),B()});function Fe(e,t){for(let n=0;n<e.length;n++){if(e[n].id===t)return e.splice(n,1),!0;if(Fe(e[n].children,t))return!0}return!1}function Re(e,t=0){let n=[];for(const o of e)n.push({...o,level:t}),o.children.length>0&&(n=n.concat(Re(o.children,t+1)));return n}function Ae(e,t){return!t||e.title.toLowerCase().includes(t)?!0:e.children.some(n=>Ae(n,t))}function Je(e,t=null,n=!1){new et(e,{group:n?"top-level-only":"nested-level-"+(t?t.id:"none"),animation:150,handle:"[data-drag-handle]",ghostClass:"sortable-ghost",dragClass:"sortable-drag",forceFallback:!0,fallbackTolerance:3,onEnd:function(o){try{if(o.oldIndex===o.newIndex){B();return}const i=JSON.parse(JSON.stringify(k));if(n){const l=i.splice(o.oldIndex,1)[0];i.splice(o.newIndex,0,l),k=i}else if(t){const l=He(i,t.id);if(l&&l.children){const E=l.children.splice(o.oldIndex,1)[0];l.children.splice(o.newIndex,0,E),k=i}else{B();return}}O(),B()}catch(i){console.error("Error in drag and drop:",i),T>0&&(k=JSON.parse(JSON.stringify(R[T]))),B()}}})}function He(e,t){if(!e||!Array.isArray(e))return null;for(const n of e){if(n.id===t)return n;if(n.children&&n.children.length>0){const o=He(n.children,t);if(o)return o}}return null}function Xt(e){return e==="bold"?"font-bold":e==="italic"?"italic":e==="bold-italic"?"font-bold italic":""}function jt(e){return!e||e.startsWith("#")?"":{red:"text-red-600",blue:"text-blue-600",green:"text-green-600",yellow:"text-yellow-600",purple:"text-purple-600"}[e]||""}function B(){fe.innerHTML="";const e=H?k.filter(t=>Ae(t,H)):k;if(e.length===0)Be.classList.remove("hidden");else{Be.classList.add("hidden");for(const t of e)fe.appendChild(Ue(t));Je(fe,null,!0)}ce({icons:de}),W()}function Ue(e,t=0){if(!e||!e.id)return console.error("Invalid node:",e),document.createElement("li");const n=document.createElement("li");n.dataset.bookmarkId=e.id,n.className="group";const o=e.children&&Array.isArray(e.children)&&e.children.length>0,i=A.has(e.id),l=C.has(e.id),g=(!H||e.title.toLowerCase().includes(H))&&H?"bg-yellow-100":"",d=e.color&&Tt[e.color]||"",h=Xt(e.style),c=jt(e.color),p=document.createElement("div");if(p.className=`flex items-center gap-2 p-2 rounded border border-gray-200 ${d} ${g} ${l?"ring-2 ring-blue-500":""} hover:bg-gray-50`,U){const a=document.createElement("input");a.type="checkbox",a.checked=l,a.className="w-4 h-4 flex-shrink-0",a.addEventListener("click",m=>{m.stopPropagation(),C.has(e.id)?C.delete(e.id):C.add(e.id),W(),a.checked=C.has(e.id),ke.classList.toggle("hidden",!U||C.size===0)}),p.appendChild(a)}const u=document.createElement("div");if(u.dataset.dragHandle="true",u.className="cursor-move flex-shrink-0",u.innerHTML='<i data-lucide="grip-vertical" class="w-4 h-4 text-gray-400"></i>',p.appendChild(u),o){const a=document.createElement("button");a.className="p-0 flex-shrink-0",a.innerHTML=i?'<i data-lucide="chevron-right" class="w-4 h-4"></i>':'<i data-lucide="chevron-down" class="w-4 h-4"></i>',a.addEventListener("click",m=>{m.stopPropagation(),A.has(e.id)?A.delete(e.id):A.add(e.id),B()}),p.appendChild(a)}else{const a=document.createElement("div");a.className="w-4 flex-shrink-0",p.appendChild(a)}const v=document.createElement("div");v.className="flex-1 min-w-0 cursor-pointer";const r=e.color&&e.color.startsWith("#")?`style="color: ${e.color}"`:"",x=e.destX!==null||e.destY!==null||e.zoom!==null?'<i data-lucide="crosshair" class="w-3 h-3 inline-block ml-1 text-blue-500"></i>':"";v.innerHTML=`
                <span class="text-sm block ${h} ${c}" ${r}>${We(e.title)}${x}</span>
                <span class="text-xs text-gray-500">Page ${e.page}</span>
            `,v.addEventListener("click",async()=>{e.destX!==null||e.destY!==null||e.zoom!==null?(await Ye(e.page,e.destX,e.destY,e.zoom),setTimeout(()=>{e.zoom!==null&&e.zoom!==""&&e.zoom!=="0"?setTimeout(()=>{Y(e.page)},1e3):Y(e.page)},2e3)):Y(e.page),window.innerWidth<1024&&K.click()}),p.appendChild(v);const S=document.createElement("div");S.className="flex gap-1 flex-shrink-0";const M=document.createElement("button");M.className="p-1 hover:bg-gray-200 rounded",M.title="Add child",M.innerHTML='<i data-lucide="plus" class="w-4 h-4"></i>',M.addEventListener("click",async a=>{a.stopPropagation();const m=await Ee("Add Child Bookmark",[{type:"text",name:"title",label:"Title",placeholder:"Enter bookmark title"}]);m&&m.title&&(e.children.push({id:Date.now()+Math.random(),title:m.title,page:D,children:[],color:null,style:null,destX:null,destY:null,zoom:null}),A.delete(e.id),O(),B())}),S.appendChild(M);const P=document.createElement("button");P.className="p-1 hover:bg-gray-200 rounded",P.title="Edit",P.innerHTML='<i data-lucide="edit-2" class="w-4 h-4"></i>',P.addEventListener("click",async a=>{a.stopPropagation();const m=await Ee("Edit Bookmark",[{type:"text",name:"title",label:"Title",placeholder:"Enter bookmark title"},{type:"select",name:"color",label:"Color",options:[{value:"",label:"None"},{value:"red",label:"Red"},{value:"blue",label:"Blue"},{value:"green",label:"Green"},{value:"yellow",label:"Yellow"},{value:"purple",label:"Purple"},{value:"custom",label:"Custom..."}]},{type:"select",name:"style",label:"Style",options:[{value:"",label:"Normal"},{value:"bold",label:"Bold"},{value:"italic",label:"Italic"},{value:"bold-italic",label:"Bold & Italic"}]},{type:"destination",label:"Destination",page:e.page,maxPages:z?z.numPages:1},{type:"preview",label:"Preview"}],{title:e.title,color:e.color||"",style:e.style||"",destPage:e.page,destX:e.destX,destY:e.destY,zoom:e.zoom});m&&(e.title=m.title,e.color=m.color||null,e.style=m.style||null,m.destPage!==null&&m.destPage!==void 0&&(e.page=m.destPage,e.destX=m.destX,e.destY=m.destY,e.zoom=m.zoom),O(),B())}),S.appendChild(P);const s=document.createElement("button");if(s.className="p-1 hover:bg-gray-200 rounded text-red-600",s.title="Delete",s.innerHTML='<i data-lucide="trash-2" class="w-4 h-4"></i>',s.addEventListener("click",async a=>{a.stopPropagation(),await te(`Delete "${e.title}"?`)&&(Fe(k,e.id),O(),B())}),S.appendChild(s),p.appendChild(S),n.appendChild(p),o&&!i){const a=document.createElement("ul");a.className="child-container space-y-2";const m=JSON.parse(JSON.stringify(e));for(const f of e.children)f&&f.id&&a.appendChild(Ue(f,t+1));n.appendChild(a),Je(a,m,!1)}return n}ze.addEventListener("click",async()=>{const e=he.value.trim();if(!e){await $("Error","Please enter a title.");return}k.push({id:Date.now(),title:e,page:D,children:[],color:null,style:null,destX:null,destY:null,zoom:null}),O(),B(),he.value=""});he.addEventListener("keypress",e=>{e.key==="Enter"&&ze.click()});function We(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}yt.addEventListener("click",()=>{ye.click(),ne.classList.add("hidden")});ye.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text(),o=Ze(n);o.length>0&&(k=o,O(),B(),await $("Success",`Imported ${o.length} bookmarks!`)),ye.value=""});vt.addEventListener("click",()=>{if(oe.classList.add("hidden"),k.length===0){$("Error","No bookmarks to export!");return}const t=`title,page,level
`+Re(k).map(l=>`"${l.title.replace(/"/g,'""')}",${l.page},${l.level}`).join(`
`),n=new Blob([t],{type:"text/csv"}),o=URL.createObjectURL(n),i=document.createElement("a");i.href=o,i.download=`${G}-bookmarks.csv`,i.click(),URL.revokeObjectURL(o)});function Ze(e){const t=e.trim().split(`
`).slice(1),n=[],o=[{children:n,level:-1}];for(const i of t){const l=i.match(/^"(.+)",(\d+),(\d+)$/)||i.match(/^([^,]+),(\d+),(\d+)$/);if(!l)continue;const[,E,g,d]=l,h={id:Date.now()+Math.random(),title:E.replace(/""/g,'"'),page:parseInt(g),children:[],color:null,style:null,destX:null,destY:null,zoom:null},c=parseInt(d);for(;o[o.length-1].level>=c;)o.pop();o[o.length-1].children.push(h),o.push({...h,level:c})}return n}bt.addEventListener("click",()=>{ve.click(),ne.classList.add("hidden")});ve.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=await t.text();try{k=JSON.parse(n),O(),B(),await $("Success","Bookmarks imported from JSON!")}catch{await $("Error","Invalid JSON format")}ve.value=""});kt.addEventListener("click",()=>{if(oe.classList.add("hidden"),k.length===0){$("Error","No bookmarks to export!");return}const e=JSON.stringify(k,null,2),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),o=document.createElement("a");o.href=n,o.download=`${G}-bookmarks.json`,o.click(),URL.revokeObjectURL(n)});xt.addEventListener("click",async()=>{if(!N)return;const e=await Ke(N);e.length>0?await te(`Found ${e.length} existing bookmarks. Replace current bookmarks?`)&&(k=e,O(),B()):await $("Info","No existing bookmarks found in this PDF.")});async function Ke(e){try{let t=function(c){return c?c.lookup?c:c.objectNumber!==void 0&&e.context?e.context.lookup(c):c:null},n=function(c){if(!c)return 0;try{const p=t(c);if(c.numberValue!==void 0){const u=c.numberValue|0;if(u>=0&&u<E.length)return u}if(c.objectNumber!==void 0){const u=E.findIndex(v=>v.ref.objectNumber===c.objectNumber);if(u!==-1)return u}if(c.toString){const u=c.toString(),v=E.findIndex(r=>r.ref.toString()===u);if(v!==-1)return v}if(p&&p.get){for(let u=0;u<E.length;u++)if(e.context.lookup(E[u].ref)===p)return u}}catch(p){console.error("Error finding page:",p)}return console.warn("Falling back to page 0 for destination"),0},o=function(c){if(!c)return null;let p=c.lookup(y.of("Dest"));if(!p){const u=t(c.lookup(y.of("A")));u&&(p=u.lookup(y.of("D")))}if(p&&!p.array)try{const u=p.decodeText?p.decodeText():p.toString();if(g.has(u))p=g.get(u);else if(p.lookup){const v=t(p),r=v&&v.lookup?v.lookup(y.of("D")):null;r&&(p=t(r))}}catch{}return t(p)},i=function(c){if(!c||(c=t(c),!c))return null;const p=c.lookup(y.of("Title")),u=o(c),v=c.lookup(y.of("C")),r=c.lookup(y.of("F"));let b=0,x=null,S=null,M=null;if(u&&u.array){const f=u.array[0];if(b=n(f),u.array.length>2){const w=t(u.array[2]),I=t(u.array[3]),X=t(u.array[4]);w&&w.numberValue!==void 0&&(x=w.numberValue),I&&I.numberValue!==void 0&&(S=I.numberValue),X&&X.numberValue!==void 0&&(M=String(Math.round(X.numberValue*100)))}}let P=null;if(v&&v.array){const[f,w,I]=v.array;f>.8&&w<.3&&I<.3?P="red":f<.3&&w<.3&&I>.8?P="blue":f<.3&&w>.8&&I<.3?P="green":f>.8&&w>.8&&I<.3?P="yellow":f>.5&&w<.5&&I>.5&&(P="purple")}let s=null;if(r){const f=r.numberValue||0,w=(f&2)!==0,I=(f&1)!==0;w&&I?s="bold-italic":w?s="bold":I&&(s="italic")}const a={id:Date.now()+Math.random(),title:p?p.decodeText():"Untitled",page:b+1,children:[],color:P,style:s,destX:x,destY:S,zoom:M};let m=t(c.lookup(y.of("First")));for(;m;){const f=i(m);f&&a.children.push(f),m=t(m.lookup(y.of("Next")))}if(b===0&&a.children.length>0){const f=a.children[0];f&&(a.page=f.page,a.destX=f.destX,a.destY=f.destY,a.zoom=f.zoom)}return a};const l=e.catalog.lookup(y.of("Outlines"));if(!l)return[];const E=e.getPages(),g=new Map;try{let c=function(r,b){try{const x=r.decodeText?r.decodeText():String(r);g.set(x,t(b))}catch{}},p=function(r){if(!r||(r=t(r),!r))return;const b=r.lookup?r.lookup(y.of("Names")):null;if(b&&b.array)for(let S=0;S<b.array.length;S+=2){const M=b.array[S],P=b.array[S+1];c(M,P)}const x=r.lookup?r.lookup(y.of("Kids")):null;if(x&&x.array)for(const S of x.array)p(S)};const u=e.catalog.lookup(y.of("Names"));if(u){const r=u.lookup(y.of("Dests"));r&&p(r)}const v=e.catalog.lookup(y.of("Dests"));if(v&&v.dict){const r=v.dict.entries();for(const[b,x]of r){const S=b.decodeText?b.decodeText():b.toString();g.set(S,t(x))}}}catch(c){console.error("Error building named destinations:",c)}const d=[];let h=t(l.lookup(y.of("First")));for(;h;){const c=i(h);c&&d.push(c),h=t(h.lookup(y.of("Next")))}return d}catch(t){return console.error("Error extracting bookmarks:",t),[]}}we&&we.addEventListener("click",()=>{window.location.href="/"});Le&&Le.addEventListener("click",()=>{window.location.href="/"});ut.addEventListener("click",async()=>{const e=N.getPages(),t=N.context.obj({}),n=N.context.register(t);function o(i,l){const E=[];for(let g=0;g<i.length;g++){const d=i[g],h=N.context.obj({}),c=N.context.register(h);h.set(y.of("Title"),tt.of(d.title)),h.set(y.of("Parent"),l);const p=Math.max(0,Math.min(d.page-1,e.length-1)),u=e[p].ref;let v;if(d.destX!==null||d.destY!==null||d.zoom!==null){const r=d.destX!==null?le.of(d.destX):null,b=d.destY!==null?le.of(d.destY):null;let x=null;d.zoom!==null&&d.zoom!==""&&d.zoom!=="0"&&(x=le.of(parseFloat(d.zoom)/100)),v=N.context.obj([u,y.of("XYZ"),r,b,x])}else v=N.context.obj([u,y.of("XYZ"),null,null,null]);if(h.set(y.of("Dest"),v),d.color){let r;if(d.color.startsWith("#")){const b=d.color.replace("#",""),x=parseInt(b.substr(0,2),16)/255,S=parseInt(b.substr(2,2),16)/255,M=parseInt(b.substr(4,2),16)/255;r=[x,S,M]}else r={red:[1,0,0],blue:[0,0,1],green:[0,1,0],yellow:[1,1,0],purple:[.5,0,.5]}[d.color];if(r){const b=N.context.obj(r);h.set(y.of("C"),b)}}if(d.style){let r=0;d.style==="italic"?r=1:d.style==="bold"?r=2:d.style==="bold-italic"&&(r=3),r>0&&h.set(y.of("F"),le.of(r))}if(d.children.length>0){const r=o(d.children,c);r.length>0&&(h.set(y.of("First"),r[0].ref),h.set(y.of("Last"),r[r.length-1].ref),h.set(y.of("Count"),N.context.obj(r.length)))}g>0&&(h.set(y.of("Prev"),E[g-1].ref),E[g-1].dict.set(y.of("Next"),c)),E.push({ref:c,dict:h})}return E}try{const i=o(k,n);i.length>0&&(t.set(y.of("Type"),y.of("Outlines")),t.set(y.of("First"),i[0].ref),t.set(y.of("Last"),i[i.length-1].ref),t.set(y.of("Count"),N.context.obj(i.length))),N.catalog.set(y.of("Outlines"),n);const l=await N.save(),E=new Blob([l],{type:"application/pdf"}),g=URL.createObjectURL(E),d=document.createElement("a");d.href=g,d.download=`${G}-bookmarked.pdf`,d.click(),URL.revokeObjectURL(g),await $("Success","PDF saved successfully!"),setTimeout(()=>{Xe()},500)}catch(i){console.error(i),await $("Error","Error saving PDF. Check console for details.")}});
